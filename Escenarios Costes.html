<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Costes FACCSA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Sticky Header Logic */
        thead th { position: sticky; background-color: #f3f4f6; z-index: 20; }
        thead tr:first-child th { top: 0; }
        thead tr:last-child th { top: 41px; z-index: 15; }
        
        /* Loading Overlay */
        #loadingOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.98);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 50; transition: opacity 0.5s ease-out;
        }
        .hidden-overlay { opacity: 0; pointer-events: none; }
        .spinner { animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">

    <!-- Loading Screen -->
    <div id="loadingOverlay">
        <div class="text-5xl text-slate-700 mb-6"><i class="fas fa-circle-notch spinner"></i></div>
        <h2 class="text-2xl font-bold text-slate-800">Cargando Datos en Tiempo Real...</h2>
        <p class="text-slate-500 mt-2">Sincronizando con Google Sheets</p>
    </div>

    <!-- Header -->
    <div class="bg-white shadow-sm z-30 relative">
        <div class="max-w-screen-2xl mx-auto p-4 md:p-6 flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-bold text-slate-800">FACCSA | Simulador de Costes</h1>
                <p class="text-xs text-emerald-600 font-medium flex items-center gap-1 mt-1">
                    <i class="fas fa-link"></i> Conectado a Google Sheets
                </p>
            </div>
            <button onclick="fetchData()" class="text-sm text-slate-500 hover:text-slate-800 underline">
                <i class="fas fa-sync-alt"></i> Refrescar Datos
            </button>
        </div>
    </div>

    <div class="mx-auto p-4 md:p-8 max-w-screen-2xl w-full flex-grow">
        <div class="bg-white rounded-xl shadow-lg overflow-hidden">
            
            <!-- Panel de Control -->
            <div class="p-6 border-b border-gray-200 bg-slate-50/50">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 items-end">
                    
                    <!-- E1 Base (Solo Lectura) -->
                    <div class="p-4 bg-white rounded-lg border border-slate-200 shadow-sm relative">
                        <div class="absolute top-2 right-2 text-xs text-slate-400" title="Datos del Sheet"><i class="fas fa-database"></i></div>
                        <h3 class="font-bold text-slate-700 mb-2">??? Escenario 1 (Base)</h3>
                        <div class="flex justify-between items-end">
                            <div>
                                <p class="text-xs text-slate-500">Cerdos</p>
                                <p class="text-lg font-mono font-bold text-slate-800" id="baseCerdos">...</p>
                            </div>
                            <div class="text-right">
                                <p class="text-xs text-slate-500">Peso</p>
                                <p class="text-lg font-mono font-bold text-slate-800"><span id="basePeso">...</span> <span class="text-xs font-normal">kg</span></p>
                            </div>
                        </div>
                    </div>

                    <!-- E2 Config -->
                    <div class="p-4 bg-sky-50 rounded-lg border border-sky-200 shadow-sm">
                        <h3 class="font-bold text-sky-800 mb-2">?? Escenario 2</h3>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="text-xs font-semibold text-sky-700">Cerdos</label>
                                <input type="text" id="cerdos2" value="105.000" class="w-full px-2 py-1 border border-sky-300 rounded text-sm text-right font-mono focus:ring-2 focus:ring-sky-500 outline-none">
                            </div>
                            <div>
                                <label class="text-xs font-semibold text-sky-700">Peso</label>
                                <input type="number" id="peso2" value="90.00" step="0.1" class="w-full px-2 py-1 border border-sky-300 rounded text-sm text-right font-mono focus:ring-2 focus:ring-sky-500 outline-none">
                            </div>
                        </div>
                    </div>

                    <!-- E3 Config -->
                    <div class="p-4 bg-amber-50 rounded-lg border border-amber-200 shadow-sm">
                        <h3 class="font-bold text-amber-800 mb-2">?? Escenario 3</h3>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="text-xs font-semibold text-amber-700">Cerdos</label>
                                <input type="text" id="cerdos3" value="95.000" class="w-full px-2 py-1 border border-amber-300 rounded text-sm text-right font-mono focus:ring-2 focus:ring-amber-500 outline-none">
                            </div>
                            <div>
                                <label class="text-xs font-semibold text-amber-700">Peso</label>
                                <input type="number" id="peso3" value="88.50" step="0.1" class="w-full px-2 py-1 border border-amber-300 rounded text-sm text-right font-mono focus:ring-2 focus:ring-amber-500 outline-none">
                            </div>
                        </div>
                    </div>

                    <!-- Botón Calcular -->
                    <button id="calcBtn" class="h-[88px] bg-slate-800 hover:bg-slate-900 text-white font-bold rounded-lg shadow-md transition-all active:scale-95 flex flex-col items-center justify-center gap-1">
                        <i class="fas fa-calculator text-xl"></i>
                        <span>RECALCULAR</span>
                    </button>
                </div>
            </div>

            <!-- Resumen Kpis -->
            <div id="kpiContainer" class="grid grid-cols-3 divide-x divide-gray-200 border-b border-gray-200 bg-white">
                <!-- Se llena con JS -->
            </div>

            <!-- Tabla Principal -->
            <div class="flex-grow overflow-auto bg-white" style="height: 60vh;">
                <table class="min-w-full divide-y divide-gray-200 text-sm">
                    <thead>
                        <tr>
                            <th class="px-4 py-3 text-left w-1/3">Concepto / Partida</th>
                            <th class="px-2 py-3 text-center w-24">Tipo</th>
                            <th class="px-4 py-3 text-right bg-slate-100 border-l">Base (€)</th>
                            <th class="px-4 py-3 text-right bg-slate-100">€/kg</th>
                            <th class="px-4 py-3 text-right bg-sky-50 border-l border-sky-100">E2 (€)</th>
                            <th class="px-4 py-3 text-right bg-sky-50">€/kg</th>
                            <th class="px-4 py-3 text-right bg-amber-50 border-l border-amber-100">E3 (€)</th>
                            <th class="px-4 py-3 text-right bg-amber-50">€/kg</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody" class="divide-y divide-gray-100">
                        <!-- Filas -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

<script>
    // =========================================================================
    //  ??????  ¡¡¡ PEGA TUS ENLACES AQUÍ ABAJO !!!  ??????
    // =========================================================================
    
    // 1. Enlace CSV de la pestaña CONFIGURACIÓN (Cerdos/Peso):
    const URL_CONFIG = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQG0Q27EpHXPy83FBcSs03iIaDPUbDFMZGcNhl15fc6uqDosyBCOk6w4UKuEIRSAYEmEHxXLp7SH2iW/pub?gid=126063802&single=true&output=csv";

    // 2. Enlace CSV de la pestaña COSTES (Listado):
    const URL_COSTES = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQG0Q27EpHXPy83FBcSs03iIaDPUbDFMZGcNhl15fc6uqDosyBCOk6w4UKuEIRSAYEmEHxXLp7SH2iW/pub?gid=2092625440&single=true&output=csv";

    // =========================================================================
    //  ??????  FIN DE LA ZONA DE EDICIÓN  ??????
    // =========================================================================

    // Estado Global
    let state = {
        cerdosBase: 98870,
        pesoBase: 88.5,
        costes: []
    };

    // Mapeo de Departamentos (Predefinidos)
    const DEP_MAPPING = {
        '01': 'ADMINISTRACION-FINANZAS',
        '02': 'CALIDAD',
        '03': 'MARKETING-COMERCIAL',
        '04': 'COMPRAS',
        '05': 'INFORMATICA',
        '06': 'GERENCIA',
        '07': 'PRODUCCION',
        '09': 'RECURSOS HUMANOS',
        '10': 'MANTENIMIENTO',
        '12': 'DIRECCIÓN GENERAL'
    };

    // Utilidades
    const parseNum = (str) => {
        if (typeof str === 'number') return str;
        if (!str) return 0;
        // Quita puntos de miles, cambia coma decimal por punto
        return parseFloat(str.replace(/\./g, '').replace(',', '.')) || 0;
    }
    
    const fmtMoney = (n) => new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR' }).format(n);
    const fmtKg = (n) => new Intl.NumberFormat('es-ES', { minimumFractionDigits: 4, maximumFractionDigits: 4 }).format(n);
    const fmtInt = (n) => new Intl.NumberFormat('es-ES', { maximumFractionDigits: 0 }).format(n);

    // CSV Parser Mejorado
    const cleanText = (val) => val ? val.replace(/^"|"$/g, '').trim() : '';
    
    const parseEuropeanNumber = (str) => {
        if (typeof str === 'number') return str;
        if (!str) return 0;
        if (!str.includes(',') && !isNaN(parseFloat(str))) return parseFloat(str);
        let cleanStr = str.replace(/\./g, '').replace(',', '.');
        return parseFloat(cleanStr) || 0;
    }

    const csvToJson = (csvText, isConfig = false) => {
        const lines = csvText.split(/\r?\n/);
        if (lines.length === 0) return [];

        const result = [];
        let delimiter = ',';
        // Detección simple de delimitador
        if (lines[0].indexOf(';') > -1) delimiter = ';';
        
        // --- 1. MODO CONFIGURACIÓN ---
        if (isConfig) {
            lines.forEach(line => {
                if(!line) return;
                const cols = line.split(delimiter);
                if(cols.length >= 2) {
                    result.push({ key: cleanText(cols[0]), value: cleanText(cols[1]) });
                }
            });
            return result;
        }

        // --- 2. MODO COSTES (INTELIGENTE) ---
        // Leemos la cabecera para buscar columnas
        const headers = lines[0].toLowerCase().split(delimiter).map(h => cleanText(h));
        
        // Buscamos índices de columnas clave
        let idxDep = headers.findIndex(h => h.includes('dep') || h.includes('cod'));
        let idxDesc = headers.findIndex(h => h.includes('desc') || h.includes('concept'));
        let idxImp = headers.findIndex(h => h.includes('imp') || h.includes('valor') || h.includes('prom'));
        let idxTipo = headers.findIndex(h => h.includes('tip'));

        // Si no encuentra cabeceras, usamos fallback por posición estándar (0, 1, 2, 3)
        if (idxDep === -1) idxDep = 0;
        if (idxDesc === -1) idxDesc = 1;
        if (idxImp === -1) {
            // Si hay hueco, puede ser la columna 3 o 4
            idxImp = lines[1].split(delimiter).length > 3 ? 3 : 2; 
        }
        if (idxTipo === -1) idxTipo = idxImp + 1;

        // Procesar filas (empezando en 1)
        for (let i = 1; i < lines.length; i++) {
            if (!lines[i].trim()) continue;
            
            // Split robusto (básico)
            let cols;
            if (delimiter === ';') {
                cols = lines[i].split(';');
            } else {
                // Regex para comas dentro de comillas
                cols = lines[i].match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g) || [];
                if (cols.length === 0) cols = lines[i].split(',');
            }

            // Extraer datos usando los índices detectados
            const depCode = cleanText(cols[idxDep] || '');
            const desc = cleanText(cols[idxDesc] || '');
            const importeRaw = cleanText(cols[idxImp] || '0');
            const tipoRaw = cleanText(cols[idxTipo] || '1');

            // Validar si la fila tiene datos útiles
            if (!depCode || !desc) continue;

            const importe = parseEuropeanNumber(importeRaw);
            const tipo = parseInt(tipoRaw) || 1;
            
            // Deducir nombre departamento
            let depName = "OTROS";
            // Si existe columna 4 o 5 con nombre, úsala, sino mapeo
            if (cols.length > Math.max(idxImp, idxTipo) + 1 && cols[Math.max(idxImp, idxTipo) + 1]) {
                 depName = cleanText(cols[Math.max(idxImp, idxTipo) + 1]);
            } else {
                const prefix = depCode.substring(0, 2);
                if (DEP_MAPPING[prefix]) depName = DEP_MAPPING[prefix];
                else if (DEP_MAPPING[depCode]) depName = DEP_MAPPING[depCode];
            }

            result.push({ dep: depCode, desc: desc, prom: importe, tipo: tipo, dep_name: depName });
        }
        return result;
    }

    // Carga de Datos
    async function fetchData() {
        if (URL_CONFIG.includes("PEGA_AQUI")) {
            alert("?? ALERTA: No has pegado los enlaces del CSV todavía.\n\nBusca la sección 'PEGA TUS ENLACES AQUÍ' en el código (líneas 140-145).");
            document.getElementById('loadingOverlay').style.display = 'none';
            return;
        }

        try {
            document.getElementById('loadingOverlay').classList.remove('hidden-overlay');
            
            const [resConfig, resCostes] = await Promise.all([
                fetch(URL_CONFIG),
                fetch(URL_COSTES)
            ]);

            const txtConfig = await resConfig.text();
            const txtCostes = await resCostes.text();

            // 1. Procesar Config
            const configData = csvToJson(txtConfig, true);
            const rowCerdos = configData.find(r => r.key.toLowerCase().includes('cerdos'));
            const rowPeso = configData.find(r => r.key.toLowerCase().includes('peso'));

            if (rowCerdos) state.cerdosBase = parseEuropeanNumber(rowCerdos.value);
            if (rowPeso) state.pesoBase = parseEuropeanNumber(rowPeso.value);
            
            // 2. Procesar Costes
            const costesParsed = csvToJson(txtCostes, false);
            if (costesParsed.length > 0) state.costes = costesParsed;

            // Actualizar UI Base
            document.getElementById('baseCerdos').textContent = fmtInt(state.cerdosBase);
            document.getElementById('basePeso').textContent = state.pesoBase.toLocaleString('es-ES');

            render();
            document.getElementById('loadingOverlay').classList.add('hidden-overlay');

        } catch (e) {
            console.error(e);
            alert("Error cargando datos. Revisa la consola y los enlaces CSV.");
            document.getElementById('loadingOverlay').classList.add('hidden-overlay');
        }
    }

    // Renderizado Principal
    function render() {
        // 1. Obtener Inputs
        const kgBase = state.cerdosBase * state.pesoBase;
        
        const cerdos2 = parseNum(document.getElementById('cerdos2').value);
        const peso2 = parseFloat(document.getElementById('peso2').value);
        const kg2 = cerdos2 * peso2;
        const factor2 = kgBase > 0 ? kg2 / kgBase : 0;

        const cerdos3 = parseNum(document.getElementById('cerdos3').value);
        const peso3 = parseFloat(document.getElementById('peso3').value);
        const kg3 = cerdos3 * peso3;
        const factor3 = kgBase > 0 ? kg3 / kgBase : 0;

        // 2. Calcular Totales
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';
        
        let total = { b: 0, e2: 0, e3: 0 };
        
        // Agrupar por Departamento
        const deps = [...new Set(state.costes.map(c => c.depName))].sort();

        deps.forEach(dep => {
            const items = state.costes.filter(c => c.depName === dep);
            if (items.length === 0) return;

            let sub = { b: 0, e2: 0, e3: 0 };

            // Cabecera Depto
            tbody.insertAdjacentHTML('beforeend', `
                <tr class="bg-gray-50 border-t border-b border-gray-200">
                    <td colspan="8" class="px-4 py-2 font-bold text-gray-700 text-xs uppercase tracking-wider">${dep}</td>
                </tr>
            `);

            items.forEach(item => {
                const c1 = item.prom;
                let c2 = 0, c3 = 0;

                if (item.tipo === 1) { // Fijo
                    c2 = c1; c3 = c1;
                } else if (item.tipo === 2) { // Variable
                    c2 = c1 * factor2; c3 = c1 * factor3;
                } else if (item.tipo === 3) { // Semifijo
                    const f = c1 * 0.81; const v = c1 * 0.19;
                    c2 = f + (v * factor2); c3 = f + (v * factor3);
                }

                sub.b += c1; sub.e2 += c2; sub.e3 += c3;

                // Estilos Tipo
                const badgeClass = item.tipo === 1 ? 'text-blue-600 bg-blue-50' : 
                                   item.tipo === 3 ? 'text-purple-600 bg-purple-50' : 'text-emerald-600 bg-emerald-50';
                const tipoLabel = item.tipo === 1 ? 'Fijo' : item.tipo === 3 ? 'Semi' : 'Var';

                tbody.insertAdjacentHTML('beforeend', `
                    <tr class="hover:bg-gray-50 transition-colors">
                        <td class="px-4 py-2 text-gray-600 font-medium">${item.desc}</td>
                        <td class="px-2 py-2 text-center"><span class="text-xs px-2 py-0.5 rounded ${badgeClass}">${tipoLabel}</span></td>
                        <td class="px-4 py-2 text-right text-gray-700 border-l">${fmtMoney(c1)}</td>
                        <td class="px-4 py-2 text-right text-gray-400 text-xs">${fmtKg(kgBase ? c1/kgBase : 0)}</td>
                        <td class="px-4 py-2 text-right text-gray-700 bg-sky-50/30 border-l border-sky-100">${fmtMoney(c2)}</td>
                        <td class="px-4 py-2 text-right text-gray-400 bg-sky-50/30 text-xs">${fmtKg(kg2 ? c2/kg2 : 0)}</td>
                        <td class="px-4 py-2 text-right text-gray-700 bg-amber-50/30 border-l border-amber-100">${fmtMoney(c3)}</td>
                        <td class="px-4 py-2 text-right text-gray-400 bg-amber-50/30 text-xs">${fmtKg(kg3 ? c3/kg3 : 0)}</td>
                    </tr>
                `);
            });

            // Subtotal
            total.b += sub.b; total.e2 += sub.e2; total.e3 += sub.e3;
            tbody.insertAdjacentHTML('beforeend', `
                <tr class="bg-gray-50/80 font-bold border-t border-gray-200 text-xs">
                    <td colspan="2" class="px-4 py-2 text-right text-gray-500">Subtotal ${dep}</td>
                    <td class="px-4 py-2 text-right text-gray-800 border-l">${fmtMoney(sub.b)}</td>
                    <td class="px-4 py-2 text-right text-gray-500">${fmtKg(kgBase ? sub.b/kgBase : 0)}</td>
                    <td class="px-4 py-2 text-right text-sky-700 bg-sky-50/50 border-l border-sky-200">${fmtMoney(sub.e2)}</td>
                    <td class="px-4 py-2 text-right text-sky-600 bg-sky-50/50">${fmtKg(kg2 ? sub.e2/kg2 : 0)}</td>
                    <td class="px-4 py-2 text-right text-amber-700 bg-amber-50/50 border-l border-amber-200">${fmtMoney(sub.e3)}</td>
                    <td class="px-4 py-2 text-right text-amber-600 bg-amber-50/50">${fmtKg(kg3 ? sub.e3/kg3 : 0)}</td>
                </tr>
            `);
        });

        // Fila Total General
        tbody.insertAdjacentHTML('beforeend', `
            <tr class="bg-slate-800 text-white font-bold text-sm sticky bottom-0 shadow-lg z-20">
                <td colspan="2" class="px-4 py-3 text-right">TOTAL GENERAL</td>
                <td class="px-4 py-3 text-right border-l border-slate-600">${fmtMoney(total.b)}</td>
                <td class="px-4 py-3 text-right text-slate-300">${fmtKg(kgBase ? total.b/kgBase : 0)}</td>
                <td class="px-4 py-3 text-right bg-slate-700 border-l border-slate-600">${fmtMoney(total.e2)}</td>
                <td class="px-4 py-3 text-right bg-slate-700 text-slate-300">${fmtKg(kg2 ? total.e2/kg2 : 0)}</td>
                <td class="px-4 py-3 text-right bg-slate-700 border-l border-slate-600">${fmtMoney(total.e3)}</td>
                <td class="px-4 py-3 text-right bg-slate-700 text-slate-300">${fmtKg(kg3 ? total.e3/kg3 : 0)}</td>
            </tr>
        `);

        // Actualizar KPIs Superiores
        const kpiHTML = (title, kg, cost, color) => `
            <div class="p-4 text-center">
                <p class="text-xs font-bold uppercase text-${color}-500 mb-1">${title}</p>
                <p class="text-2xl font-bold text-slate-800">${fmtInt(kg)} <span class="text-sm font-normal text-gray-400">kg</span></p>
                <p class="text-sm font-semibold text-${color}-600 bg-${color}-50 inline-block px-2 py-0.5 rounded mt-1">
                    ${fmtKg(kg ? (title.includes('Base')?total.b:title.includes('2')?total.e2:total.e3)/kg : 0)} €/kg
                </p>
            </div>
        `;

        document.getElementById('kpiContainer').innerHTML = 
            kpiHTML('Escenario Base', kgBase, total.b, 'slate') +
            kpiHTML('Escenario 2', kg2, total.e2, 'sky') +
            kpiHTML('Escenario 3', kg3, total.e3, 'amber');
    }

    // Inicialización
    document.addEventListener('DOMContentLoaded', () => {
        fetchData();
        
        // Listeners Inputs
        ['cerdos2', 'cerdos3'].forEach(id => {
            const el = document.getElementById(id);
            el.addEventListener('input', (e) => {
                let v = e.target.value.replace(/\D/g, '');
                e.target.value = v ? parseInt(v).toLocaleString('es-ES') : '';
            });
        });

        document.getElementById('calcBtn').addEventListener('click', render);
    });
</script>
</body>
</html>