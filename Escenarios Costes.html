<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Costes FACCSA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; }
        thead th { position: sticky; background-color: #f3f4f6; z-index: 30; }
        thead tr:first-child th { top: 0; }
        thead tr:last-child th { top: 41px; z-index: 25; }
        
        #loadingOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.98);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 50; transition: opacity 0.5s ease-out;
        }
        .hidden-overlay { opacity: 0; pointer-events: none; }
        .spinner { animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        .dept-header { cursor: pointer; transition: background-color 0.2s; }
        .dept-header:hover { background-color: #e2e8f0; }
        .chevron { transition: transform 0.3s; }
        .expanded .chevron { transform: rotate(180deg); }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">

    <div id="loadingOverlay">
        <div class="text-5xl text-slate-700 mb-6"><i class="fas fa-circle-notch spinner"></i></div>
        <h2 class="text-2xl font-bold text-slate-800">Cargando Datos...</h2>
        <p class="text-slate-500 mt-2">Leyendo estructura del CSV</p>
    </div>

    <!-- Header -->
    <div class="bg-white shadow-sm z-30 relative">
        <div class="max-w-screen-2xl mx-auto p-4 md:p-6 flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-bold text-slate-800">FACCSA | Simulador de Costes</h1>
                <p class="text-xs text-emerald-600 font-medium flex items-center gap-1 mt-1">
                    <i class="fas fa-link"></i> Conectado a Google Sheets
                </p>
            </div>
            <button onclick="location.reload()" class="text-sm text-slate-500 hover:text-slate-800 underline">
                <i class="fas fa-sync-alt"></i> Refrescar Datos
            </button>
        </div>
    </div>

    <div class="mx-auto p-4 md:p-8 max-w-screen-2xl w-full flex-grow">
        <div class="bg-white rounded-xl shadow-lg overflow-hidden">
            
            <!-- Panel de Control -->
            <div class="p-6 border-b border-gray-200 bg-slate-50/50">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 items-end">
                    
                    <!-- E1 Base -->
                    <div class="p-4 bg-white rounded-lg border border-slate-200 shadow-sm relative">
                        <div class="absolute top-2 right-2 text-xs text-slate-400" title="Datos del Sheet"><i class="fas fa-database"></i></div>
                        <h3 class="font-bold text-slate-700 mb-2">üè≥Ô∏è Escenario 1 (Base)</h3>
                        <div class="flex justify-between items-end">
                            <div>
                                <p class="text-xs text-slate-500">Cerdos</p>
                                <p class="text-lg font-mono font-bold text-slate-800" id="baseCerdos">...</p>
                            </div>
                            <div class="text-right">
                                <p class="text-xs text-slate-500">Peso</p>
                                <p class="text-lg font-mono font-bold text-slate-800"><span id="basePeso">...</span> <span class="text-xs font-normal">kg</span></p>
                            </div>
                        </div>
                    </div>

                    <!-- E2 Config -->
                    <div class="p-4 bg-sky-50 rounded-lg border border-sky-200 shadow-sm">
                        <h3 class="font-bold text-sky-800 mb-2">üü¶ Escenario 2</h3>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="text-xs font-semibold text-sky-700">Cerdos</label>
                                <input type="text" id="cerdos2" value="105.000" class="w-full px-2 py-1 border border-sky-300 rounded text-sm text-right font-mono focus:ring-2 focus:ring-sky-500 outline-none">
                            </div>
                            <div>
                                <label class="text-xs font-semibold text-sky-700">Peso</label>
                                <input type="number" id="peso2" value="90.00" step="0.1" class="w-full px-2 py-1 border border-sky-300 rounded text-sm text-right font-mono focus:ring-2 focus:ring-sky-500 outline-none">
                            </div>
                        </div>
                    </div>

                    <!-- E3 Config -->
                    <div class="p-4 bg-amber-50 rounded-lg border border-amber-200 shadow-sm">
                        <h3 class="font-bold text-amber-800 mb-2">üüß Escenario 3</h3>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="text-xs font-semibold text-amber-700">Cerdos</label>
                                <input type="text" id="cerdos3" value="95.000" class="w-full px-2 py-1 border border-amber-300 rounded text-sm text-right font-mono focus:ring-2 focus:ring-amber-500 outline-none">
                            </div>
                            <div>
                                <label class="text-xs font-semibold text-amber-700">Peso</label>
                                <input type="number" id="peso3" value="88.50" step="0.1" class="w-full px-2 py-1 border border-amber-300 rounded text-sm text-right font-mono focus:ring-2 focus:ring-amber-500 outline-none">
                            </div>
                        </div>
                    </div>

                    <button id="calcBtn" class="h-[88px] bg-slate-800 hover:bg-slate-900 text-white font-bold rounded-lg shadow-md transition-all active:scale-95 flex flex-col items-center justify-center gap-1">
                        <i class="fas fa-calculator text-xl"></i>
                        <span>RECALCULAR</span>
                    </button>
                </div>
            </div>

            <div id="kpiContainer" class="grid grid-cols-3 divide-x divide-gray-200 border-b border-gray-200 bg-white"></div>

            <div class="flex-grow overflow-auto bg-white" style="height: 60vh;">
                <table class="min-w-full divide-y divide-gray-200 text-sm">
                    <thead>
                        <tr>
                            <th class="px-4 py-3 text-left w-1/3 pl-8">Partida / Descripci√≥n</th>
                            <th class="px-2 py-3 text-center w-24">Tipo</th>
                            <th class="px-4 py-3 text-right bg-slate-100 border-l">Base (‚Ç¨)</th>
                            <th class="px-4 py-3 text-right bg-slate-100">‚Ç¨/kg</th>
                            <th class="px-4 py-3 text-right bg-sky-50 border-l border-sky-100">E2 (‚Ç¨)</th>
                            <th class="px-4 py-3 text-right bg-sky-50">‚Ç¨/kg</th>
                            <th class="px-4 py-3 text-right bg-amber-50 border-l border-amber-100">E3 (‚Ç¨)</th>
                            <th class="px-4 py-3 text-right bg-amber-50">‚Ç¨/kg</th>
                        </tr>
                    </thead>
                    <tbody id="mainTableBody"></tbody>
                </table>
            </div>
        </div>
        
        <!-- ZONA DE DIAGN√ìSTICO -->
        <div class="max-w-screen-2xl mx-auto p-4 mt-8 bg-slate-900 text-slate-300 rounded-lg overflow-x-auto shadow-2xl">
            <h3 class="text-sm font-bold text-white mb-2 uppercase border-b border-slate-700 pb-2">üõ†Ô∏è Diagn√≥stico de Columnas (Primeras 5 filas)</h3>
            <table class="w-full text-xs font-mono text-left whitespace-nowrap" id="debugTable">
                <thead>
                    <tr class="bg-slate-800 text-slate-400">
                        <th class="p-2 border-r border-slate-700">Fila</th>
                        <th class="p-2 border-r border-slate-700 text-yellow-300 font-bold">[0] A</th>
                        <th class="p-2 border-r border-slate-700 text-yellow-300 font-bold">[1] B</th>
                        <th class="p-2 border-r border-slate-700 text-yellow-300 font-bold">[2] C</th>
                        <th class="p-2 border-r border-slate-700 text-yellow-300 font-bold">[3] D</th>
                        <th class="p-2 text-yellow-300 font-bold">[4] E</th>
                    </tr>
                </thead>
                <tbody id="debugBody"></tbody>
            </table>
        </div>
    </div>

<script>
    // =========================================================================
    //  ‚¨áÔ∏è‚¨áÔ∏è‚¨áÔ∏è  CONFIGURACI√ìN  ‚¨áÔ∏è‚¨áÔ∏è‚¨áÔ∏è
    // =========================================================================
    
    // Configura aqu√≠ tus enlaces CSV p√∫blicos de Google Sheets
    const URL_CONFIG = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQG0Q27EpHXPy83FBcSs03iIaDPUbDFMZGcNhl15fc6uqDosyBCOk6w4UKuEIRSAYEmEHxXLp7SH2iW/pub?gid=126063802&single=true&output=csv";
    const URL_COSTES = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQG0Q27EpHXPy83FBcSs03iIaDPUbDFMZGcNhl15fc6uqDosyBCOk6w4UKuEIRSAYEmEHxXLp7SH2iW/pub?gid=2092625440&single=true&output=csv";

    // 2. MAPEO DE COLUMNAS (A, B, C, D) - AJUSTADO PARA TU CSV
    const COL_A = 0; // Departamento (si tiene texto) O Vac√≠o
    const COL_B = 1; // Descripci√≥n (con n√∫meros a veces)
    const COL_C = 2; // Importe
    const COL_D = 3; // Tipo
    
    // =========================================================================

    let state = { cerdosBase: 98870, pesoBase: 88.5, costes: [] };

    // --- PARSERS ---
    const cleanText = (val) => val ? val.replace(/^"|"$/g, '').trim() : '';
    
    const parseNum = (str) => {
        if (typeof str === 'number') return str;
        if (!str) return 0;
        if (!str.includes(',') && !str.includes('.') && !isNaN(parseFloat(str))) return parseFloat(str);
        if (str.includes('.') && !str.includes(',') && !isNaN(parseFloat(str))) return parseFloat(str);
        
        let cleanStr = str.toString().replace(/[^\d.,-]/g, '');
        // Asume formato ES (1.234,56) -> JS (1234.56)
        cleanStr = cleanStr.replace(/\./g, '').replace(',', '.');
        return parseFloat(cleanStr) || 0;
    };

    const fmtMoney = (n) => new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR' }).format(n);
    const fmtKg = (n) => new Intl.NumberFormat('es-ES', { minimumFractionDigits: 4, maximumFractionDigits: 4 }).format(n);
    const fmtInt = (n) => new Intl.NumberFormat('es-ES', { maximumFractionDigits: 0 }).format(n);

    // --- PROCESAMIENTO CSV ---
    const processCostesCSV = (text) => {
        const lines = text.split(/\r?\n/).filter(line => line.trim() !== '');
        if (lines.length === 0) return [];

        let delimiter = lines[0].indexOf(';') > -1 ? ';' : ',';
        
        const result = [];
        const debugBody = document.getElementById('debugBody');
        debugBody.innerHTML = ''; 

        // Variables de estado para el parseo secuencial
        let currentDept = "SIN ASIGNAR";

        // Iterar filas (empezamos en i=1 para saltar cabecera)
        for (let i = 1; i < lines.length; i++) {
            let rowText = lines[i];
            let cols;
            
            if (delimiter === ';') {
                cols = rowText.split(';');
            } else {
                // Regex robusta para CSV est√°ndar
                cols = rowText.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g) || [];
                if (cols.length < 2) cols = rowText.split(','); 
            }
            cols = cols.map(c => cleanText(c));

            // DEBUG visual en la web (primeras 6 filas)
            if (i < 7) { 
                let rowHtml = `<tr class="border-b border-slate-700 hover:bg-slate-600"><td class="p-2 border-r border-slate-700 text-slate-400 font-mono">${i}</td>`;
                for(let k=0; k<5; k++) rowHtml += `<td class="p-2 border-r border-slate-700 truncate max-w-[150px]">${cols[k] || '-'}</td>`;
                rowHtml += `</tr>`;
                debugBody.insertAdjacentHTML('beforeend', rowHtml);
            }

            // Datos usando el nuevo mapeo
            const colA = cols[COL_A] || ''; // Posible nombre de departamento
            let desc = cols[COL_B] || ''; // Descripci√≥n de partida
            const importeRaw = cols[COL_C] || '0';
            const tipoRaw = cols[COL_D] || '1';

            // --- L√ìGICA DE AGRUPACI√ìN CORREGIDA ---
            
            // 1. ¬øEs una fila de cabecera de DEPARTAMENTO?
            // Si la Columna A tiene texto (ej: "01 ADMINISTRACION")
            if (colA !== '') {
                // Limpiar el c√≥digo num√©rico inicial si existe (ej: "01 ADMINISTRACION" -> "ADMINISTRACION")
                // Pero manteniendo el nombre completo para claridad
                currentDept = colA; 
                
                // Si esta fila NO tiene importe, asumimos que es solo cabecera y saltamos
                // Pero cuidado: a veces la cabecera tiene el total. Vamos a asumir que si tiene descripci√≥n vac√≠a en B, es cabecera.
                if (desc === '') continue;
            }

            // 2. ¬øEs una partida v√°lida?
            // Debe tener descripci√≥n en Col B
            // Ignorar filas de totales basura del sistema origen
            if (!desc || desc.toLowerCase().includes('total') || desc.toLowerCase().includes('realmes')) continue;

            const importe = parseNum(importeRaw);
            const tipo = parseInt(tipoRaw) || 1;

            // Limpieza de descripci√≥n: Quitar c√≥digo num√©rico inicial si existe (ej: "010101 CUOTAS" -> "CUOTAS")
            // Regex: Busca n√∫meros al principio seguidos de espacio
            desc = desc.replace(/^\d+\s+/, '');

            // A√±adir partida solo si hay una descripci√≥n v√°lida
            // Y si tiene importe, o es una partida que queremos listar aunque sea 0
            if (desc) {
                result.push({
                    dep_name: currentDept, // Usamos el departamento "memorizado"
                    desc: desc,
                    prom: importe,
                    tipo: tipo
                });
            }
        }
        return result;
    };

    const processConfigCSV = (text) => {
        const lines = text.split(/\r?\n/);
        let delimiter = text.indexOf(';') > -1 ? ';' : ',';
        lines.forEach(line => {
            if (!line.trim()) return;
            const cols = line.split(delimiter);
            if (cols.length < 2) return;
            const key = cleanText(cols[0]).toLowerCase();
            const val = parseNum(cleanText(cols[1]));
            if (key.includes('cerdos')) state.cerdosBase = val;
            if (key.includes('peso')) state.pesoBase = val;
        });
    };

    // --- CARGA ---
    async function fetchData() {
        const overlay = document.getElementById('loadingOverlay');
        try {
            overlay.classList.remove('hidden-overlay');
            const [resConfig, resCostes] = await Promise.all([
                fetch(URL_CONFIG),
                fetch(URL_COSTES)
            ]);
            
            const txtConfig = await resConfig.text();
            const txtCostes = await resCostes.text();

            processConfigCSV(txtConfig);
            state.costes = processCostesCSV(txtCostes);

            document.getElementById('baseCerdos').textContent = fmtInt(state.cerdosBase);
            document.getElementById('basePeso').textContent = state.pesoBase.toLocaleString('es-ES');

            render();
            overlay.classList.add('hidden-overlay');
        } catch (e) {
            console.error(e);
            alert("Error cargando datos.");
        }
    }

    // --- RENDER ---
    function render() {
        const kgBase = state.cerdosBase * state.pesoBase;
        
        const cerdos2 = parseNum(document.getElementById('cerdos2').value);
        const peso2 = parseFloat(document.getElementById('peso2').value);
        const kg2 = cerdos2 * peso2;
        const factor2 = kgBase > 0 ? kg2 / kgBase : 0;

        const cerdos3 = parseNum(document.getElementById('cerdos3').value);
        const peso3 = parseFloat(document.getElementById('peso3').value);
        const kg3 = cerdos3 * peso3;
        const factor3 = kgBase > 0 ? kg3 / kgBase : 0;

        const mainBody = document.getElementById('mainTableBody');
        mainBody.innerHTML = '';
        
        let total = { b: 0, e2: 0, e3: 0 };
        
        const deps = [...new Set(state.costes.map(c => c.dep_name))].sort();

        deps.forEach((dep, index) => {
            const items = state.costes.filter(c => c.dep_name === dep);
            if (items.length === 0) return;

            let sub = { b: 0, e2: 0, e3: 0 };

            items.forEach(item => {
                const c1 = item.prom;
                let c2 = 0, c3 = 0;
                if (item.tipo === 1) { c2 = c1; c3 = c1; } 
                else if (item.tipo === 2) { c2 = c1 * factor2; c3 = c1 * factor3; } 
                else if (item.tipo === 3) { 
                    const f = c1 * 0.81; const v = c1 * 0.19;
                    c2 = f + (v * factor2); c3 = f + (v * factor3);
                }
                item.calc = { c1, c2, c3 }; 
                sub.b += c1; sub.e2 += c2; sub.e3 += c3;
            });

            total.b += sub.b; total.e2 += sub.e2; total.e3 += sub.e3;

            const collapseId = `dept-${index}`;
            
            let tbodyHtml = `
                <tbody class="border-b border-gray-200 group">
                    <tr class="dept-header bg-gray-50 hover:bg-gray-100" onclick="toggleDept('${collapseId}', this)">
                        <td class="px-4 py-3 font-bold text-gray-700 flex items-center gap-2">
                            <i class="fas fa-chevron-down text-xs text-gray-400 chevron transition-transform"></i>
                            ${dep}
                        </td>
                        <td class="px-2 py-3 text-center text-xs text-gray-400 font-mono">${items.length}</td>
                        <td class="px-4 py-3 text-right font-bold text-gray-800 border-l border-gray-200 bg-gray-50">${fmtMoney(sub.b)}</td>
                        <td class="px-4 py-3 text-right text-xs text-gray-500 bg-gray-50">${fmtKg(kgBase ? sub.b/kgBase : 0)}</td>
                        <td class="px-4 py-3 text-right font-bold text-sky-700 bg-sky-50/50 border-l border-sky-100">${fmtMoney(sub.e2)}</td>
                        <td class="px-4 py-3 text-right text-xs text-sky-600 bg-sky-50/50">${fmtKg(kg2 ? sub.e2/kg2 : 0)}</td>
                        <td class="px-4 py-3 text-right font-bold text-amber-700 bg-amber-50/50 border-l border-amber-100">${fmtMoney(sub.e3)}</td>
                        <td class="px-4 py-3 text-right text-xs text-amber-600 bg-amber-50/50">${fmtKg(kg3 ? sub.e3/kg3 : 0)}</td>
                    </tr>
            `;

            items.forEach(item => {
                const {c1, c2, c3} = item.calc;
                const badgeClass = item.tipo === 1 ? 'text-blue-600 bg-blue-50' : 
                                   item.tipo === 3 ? 'text-purple-600 bg-purple-50' : 'text-emerald-600 bg-emerald-50';
                const tipoLabel = item.tipo === 1 ? 'Fijo' : item.tipo === 3 ? 'Semi' : 'Var';

                tbodyHtml += `
                    <tr class="dept-row ${collapseId} hidden bg-white hover:bg-slate-50 border-t border-slate-100 transition-colors">
                        <td class="px-4 py-2 pl-10 text-sm text-gray-600">${item.desc}</td>
                        <td class="px-2 py-2 text-center"><span class="text-[10px] px-1.5 py-0.5 rounded border border-opacity-20 ${badgeClass}">${tipoLabel}</span></td>
                        <td class="px-4 py-2 text-right text-sm text-gray-600 border-l border-slate-100">${fmtMoney(c1)}</td>
                        <td class="px-4 py-2 text-right text-[10px] text-gray-400">${fmtKg(kgBase ? c1/kgBase : 0)}</td>
                        <td class="px-4 py-2 text-right text-sm text-gray-600 bg-sky-50/10 border-l border-sky-50">${fmtMoney(c2)}</td>
                        <td class="px-4 py-2 text-right text-[10px] text-gray-400 bg-sky-50/10">${fmtKg(kg2 ? c2/kg2 : 0)}</td>
                        <td class="px-4 py-2 text-right text-sm text-gray-600 bg-amber-50/10 border-l border-amber-50">${fmtMoney(c3)}</td>
                        <td class="px-4 py-2 text-right text-[10px] text-gray-400 bg-amber-50/10">${fmtKg(kg3 ? c3/kg3 : 0)}</td>
                    </tr>
                `;
            });

            tbodyHtml += `</tbody>`;
            mainBody.insertAdjacentHTML('beforeend', tbodyHtml);
        });

        mainBody.insertAdjacentHTML('beforeend', `
            <tfoot class="sticky bottom-0 z-40 shadow-[0_-5px_10px_-5px_rgba(0,0,0,0.1)]">
                <tr class="bg-slate-800 text-white font-bold text-sm">
                    <td colspan="2" class="px-4 py-3 text-right">TOTAL GENERAL</td>
                    <td class="px-4 py-3 text-right border-l border-slate-600">${fmtMoney(total.b)}</td>
                    <td class="px-4 py-3 text-right text-slate-300 font-mono">${fmtKg(kgBase ? total.b/kgBase : 0)}</td>
                    <td class="px-4 py-3 text-right bg-slate-700 border-l border-slate-600">${fmtMoney(total.e2)}</td>
                    <td class="px-4 py-3 text-right bg-slate-700 text-slate-300 font-mono">${fmtKg(kg2 ? total.e2/kg2 : 0)}</td>
                    <td class="px-4 py-3 text-right bg-slate-700 border-l border-slate-600">${fmtMoney(total.e3)}</td>
                    <td class="px-4 py-3 text-right bg-slate-700 text-slate-300 font-mono">${fmtKg(kg3 ? total.e3/kg3 : 0)}</td>
                </tr>
            </tfoot>
        `);

        document.getElementById('kpiContainer').innerHTML = 
            kpiHTML('Escenario Base', kgBase, total.b, 'slate') +
            kpiHTML('Escenario 2', kg2, total.e2, 'sky') +
            kpiHTML('Escenario 3', kg3, total.e3, 'amber');
    }

    const kpiHTML = (title, kg, cost, color) => `
        <div class="p-4 text-center">
            <p class="text-xs font-bold uppercase text-${color}-500 mb-1">${title}</p>
            <p class="text-2xl font-bold text-slate-800">${fmtInt(kg)} <span class="text-sm font-normal text-gray-400">kg</span></p>
            <p class="text-sm font-semibold text-${color}-600 bg-${color}-50 inline-block px-2 py-0.5 rounded mt-1">
                ${fmtKg(kg ? (title.includes('Base')?cost:title.includes('2')?cost:cost)/kg : 0)} ‚Ç¨/kg
            </p>
        </div>
    `;

    window.toggleDept = function(id, headerEl) {
        const rows = document.getElementsByClassName(id);
        const isHidden = rows[0].classList.contains('hidden');
        if(isHidden) headerEl.classList.add('expanded');
        else headerEl.classList.remove('expanded');
        for (let row of rows) {
            if (isHidden) row.classList.remove('hidden');
            else row.classList.add('hidden');
        }
    };

    document.addEventListener('DOMContentLoaded', () => {
        fetchData();
        ['cerdos2', 'cerdos3'].forEach(id => {
            const el = document.getElementById(id);
            el.addEventListener('input', (e) => {
                let v = e.target.value.replace(/\D/g, '');
                e.target.value = v ? parseInt(v).toLocaleString('es-ES') : '';
            });
        });
        document.getElementById('calcBtn').addEventListener('click', render);
    });
</script>
</body>
</html>