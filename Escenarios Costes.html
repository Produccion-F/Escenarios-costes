<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Costes FACCSA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; }
        
        /* Sticky Header CORREGIDO */
        thead th { 
            position: sticky; 
            top: 0; 
            background-color: #f3f4f6; 
            z-index: 30;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        /* Loading Overlay */
        #loadingOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.98);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 50; transition: opacity 0.5s ease-out;
        }
        .hidden-overlay { opacity: 0; pointer-events: none; }
        .spinner { animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* Estilos Acorde√≥n */
        .dept-row { cursor: pointer; transition: background-color 0.2s; }
        .dept-row:hover { background-color: #f1f5f9; }
        .chevron { transition: transform 0.3s ease; }
        .expanded .chevron { transform: rotate(180deg); }
        .sub-row { background-color: #ffffff; }
        .sub-row:hover { background-color: #f8fafc; }

        /* Estilos Toggle Switch Simple */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #10B981;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #10B981;
        }
        
        /* Tooltip simple para el mix */
        [data-title]:hover:after {
            content: attr(data-title);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #334155;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            white-space: nowrap;
            z-index: 50;
            pointer-events: none;
            margin-bottom: 5px;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">

    <!-- Loading Screen -->
    <div id="loadingOverlay">
        <div class="text-5xl text-slate-700 mb-6"><i class="fas fa-circle-notch spinner"></i></div>
        <h2 class="text-2xl font-bold text-slate-800">Cargando Datos...</h2>
        <p class="text-slate-500 mt-2">Procesando estructura de Base de Datos</p>
    </div>

    <!-- Header -->
    <div class="bg-white shadow-sm z-30 relative">
        <div class="max-w-screen-2xl mx-auto px-4 py-3 flex justify-between items-center">
            <div>
                <h1 class="text-lg font-bold text-slate-800">FACCSA | Simulador de Costes</h1>
                <p class="text-[10px] text-emerald-600 font-medium flex items-center gap-1">
                    <i class="fas fa-database"></i> DB Mode Online
                </p>
            </div>
            <button onclick="location.reload()" class="text-xs text-slate-500 hover:text-slate-800 underline">
                <i class="fas fa-sync-alt"></i> Refrescar
            </button>
        </div>
    </div>

    <div class="mx-auto px-4 pb-4 max-w-screen-2xl w-full flex-grow flex flex-col h-full">
        <div class="bg-white rounded-xl shadow-lg overflow-hidden flex flex-col h-full">
            
            <!-- Panel de Control COMPACTO -->
            <div class="p-3 border-b border-gray-200 bg-slate-50/50">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-3 items-stretch">
                    
                    <!-- E1 Base Compacto -->
                    <div class="p-3 bg-white rounded border border-slate-200 shadow-sm relative flex flex-col justify-between">
                        <div class="absolute top-2 right-2 text-[10px] text-slate-400" title="Datos del Sheet"><i class="fas fa-database"></i></div>
                        <h3 class="font-bold text-slate-700 text-xs uppercase mb-2">üè≥Ô∏è E1 (Base)</h3>
                        <div class="flex justify-between items-end mb-2">
                            <div>
                                <p class="text-[10px] text-slate-500 uppercase">Cerdos</p>
                                <p class="text-sm font-mono font-bold text-slate-800" id="baseCerdos">...</p>
                            </div>
                            <div class="text-right">
                                <p class="text-[10px] text-slate-500 uppercase">Peso</p>
                                <p class="text-sm font-mono font-bold text-slate-800"><span id="basePeso">...</span> <span class="text-[10px] font-normal">kg</span></p>
                            </div>
                        </div>
                        <div class="pt-2 border-t border-slate-100 flex justify-between items-center">
                             <p class="text-[10px] text-slate-400 font-bold uppercase">Total Kg</p>
                             <p class="text-sm font-mono font-bold text-slate-600" id="baseTotalKg">...</p>
                        </div>
                    </div>

                    <!-- E2 Config Compacto -->
                    <div class="p-3 bg-sky-50 rounded border border-sky-200 shadow-sm flex flex-col justify-between">
                        <h3 class="font-bold text-sky-800 text-xs uppercase mb-2">üü¶ Escenario 2</h3>
                        
                        <!-- Inputs Cerdos/Peso -->
                        <div class="grid grid-cols-2 gap-2 mb-2">
                            <div>
                                <label class="text-[10px] font-semibold text-sky-700 uppercase">Cerdos</label>
                                <input type="text" id="cerdos2" value="105.000" class="w-full px-1.5 py-0.5 border border-sky-300 rounded text-xs text-right font-mono focus:ring-1 focus:ring-sky-500 outline-none disabled:bg-slate-100 disabled:text-slate-400 transition-colors">
                            </div>
                            <div>
                                <label class="text-[10px] font-semibold text-sky-700 uppercase">Peso</label>
                                <input type="number" id="peso2" value="90.00" step="0.1" class="w-full px-1.5 py-0.5 border border-sky-300 rounded text-xs text-right font-mono focus:ring-1 focus:ring-sky-500 outline-none disabled:bg-slate-100 disabled:text-slate-400 transition-colors">
                            </div>
                        </div>

                        <!-- Secci√≥n Total KG -->
                        <div class="pt-2 border-t border-sky-200">
                            <div class="flex items-center justify-between mb-1">
                                <label class="text-[10px] font-bold text-sky-800 uppercase">Total Kg</label>
                                <label class="inline-flex items-center cursor-pointer scale-75 origin-right">
                                    <input type="checkbox" id="checkManual2" class="sr-only peer">
                                    <div class="relative w-9 h-5 bg-sky-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-sky-600"></div>
                                    <span class="ms-2 text-[10px] font-medium text-sky-700">Manual</span>
                                </label>
                            </div>
                            <input type="text" id="totalKg2" disabled class="w-full px-1.5 py-0.5 border border-sky-300 rounded text-xs text-right font-mono focus:ring-1 focus:ring-sky-500 outline-none disabled:bg-sky-100/50 disabled:text-sky-800/60 font-bold transition-colors">
                        </div>
                    </div>

                    <!-- E3 Config Compacto -->
                    <div class="p-3 bg-amber-50 rounded border border-amber-200 shadow-sm flex flex-col justify-between">
                        <h3 class="font-bold text-amber-800 text-xs uppercase mb-2">üüß Escenario 3</h3>

                        <!-- Inputs Cerdos/Peso -->
                        <div class="grid grid-cols-2 gap-2 mb-2">
                            <div>
                                <label class="text-[10px] font-semibold text-amber-700 uppercase">Cerdos</label>
                                <input type="text" id="cerdos3" value="95.000" class="w-full px-1.5 py-0.5 border border-amber-300 rounded text-xs text-right font-mono focus:ring-1 focus:ring-amber-500 outline-none disabled:bg-slate-100 disabled:text-slate-400 transition-colors">
                            </div>
                            <div>
                                <label class="text-[10px] font-semibold text-amber-700 uppercase">Peso</label>
                                <input type="number" id="peso3" value="88.50" step="0.1" class="w-full px-1.5 py-0.5 border border-amber-300 rounded text-xs text-right font-mono focus:ring-1 focus:ring-amber-500 outline-none disabled:bg-slate-100 disabled:text-slate-400 transition-colors">
                            </div>
                        </div>

                        <!-- Secci√≥n Total KG -->
                        <div class="pt-2 border-t border-amber-200">
                             <div class="flex items-center justify-between mb-1">
                                <label class="text-[10px] font-bold text-amber-800 uppercase">Total Kg</label>
                                <label class="inline-flex items-center cursor-pointer scale-75 origin-right">
                                    <input type="checkbox" id="checkManual3" class="sr-only peer">
                                    <div class="relative w-9 h-5 bg-amber-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-amber-600"></div>
                                    <span class="ms-2 text-[10px] font-medium text-amber-700">Manual</span>
                                </label>
                            </div>
                            <input type="text" id="totalKg3" disabled class="w-full px-1.5 py-0.5 border border-amber-300 rounded text-xs text-right font-mono focus:ring-1 focus:ring-amber-500 outline-none disabled:bg-amber-100/50 disabled:text-amber-800/60 font-bold transition-colors">
                        </div>
                    </div>

                    <button id="calcBtn" class="bg-slate-800 hover:bg-slate-900 text-white font-bold rounded shadow-md transition-all active:scale-95 flex flex-col items-center justify-center gap-1 p-2 h-full">
                        <i class="fas fa-calculator text-lg"></i>
                        <span class="text-xs">RECALCULAR</span>
                    </button>
                </div>
            </div>

            <!-- KPIs Compactos -->
            <div id="kpiContainer" class="grid grid-cols-3 divide-x divide-gray-200 border-b border-gray-200 bg-white"></div>

            <!-- Tabla Expandida -->
            <div class="flex-grow overflow-auto bg-white" style="height: 68vh;">
                <table class="min-w-full divide-y divide-gray-200 text-sm">
                    <thead>
                        <tr>
                            <th class="px-4 py-2 text-left w-1/3 pl-8 text-xs uppercase tracking-wider text-gray-500">Departamento / Centro de Gesti√≥n</th>
                            <th class="px-2 py-2 text-center w-36 text-xs uppercase tracking-wider text-gray-500">Tipo</th>
                            <th class="px-4 py-2 text-right bg-slate-100 border-l text-xs uppercase tracking-wider text-gray-600">Base (‚Ç¨)</th>
                            <th class="px-4 py-2 text-right bg-slate-100 text-xs uppercase tracking-wider text-gray-600">‚Ç¨/kg</th>
                            <th class="px-4 py-2 text-right bg-sky-50 border-l border-sky-100 text-xs uppercase tracking-wider text-sky-700">E2 (‚Ç¨)</th>
                            <th class="px-4 py-2 text-right bg-sky-50 text-xs uppercase tracking-wider text-sky-700">‚Ç¨/kg</th>
                            <th class="px-4 py-2 text-right bg-amber-50 border-l border-amber-100 text-xs uppercase tracking-wider text-amber-700">E3 (‚Ç¨)</th>
                            <th class="px-4 py-2 text-right bg-amber-50 text-xs uppercase tracking-wider text-amber-700">‚Ç¨/kg</th>
                        </tr>
                    </thead>
                    <tbody id="mainTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

<script>
    // =========================================================================
    //  CONFIGURACI√ìN GOOGLE SHEETS
    // =========================================================================
    const URL_CONFIG = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQG0Q27EpHXPy83FBcSs03iIaDPUbDFMZGcNhl15fc6uqDosyBCOk6w4UKuEIRSAYEmEHxXLp7SH2iW/pub?gid=126063802&single=true&output=csv";
    const URL_COSTES = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQG0Q27EpHXPy83FBcSs03iIaDPUbDFMZGcNhl15fc6uqDosyBCOk6w4UKuEIRSAYEmEHxXLp7SH2iW/pub?gid=2092625440&single=true&output=csv";

    // Columnas DB
    const COL_DEPARTAMENTO = 0;
    const COL_CENTRO_GESTION = 1;
    const COL_IMPORTE = 2;
    const COL_TIPO = 3;

    // Estado de la aplicaci√≥n
    let state = {
        cerdosBase: 98870,
        pesoBase: 88.5,
        departamentos: [] 
    };

    // --- PARSERS Y FORMATOS ---
    const cleanText = (val) => val ? val.replace(/^"|"$/g, '').trim() : '';
    
    const parseNum = (str) => {
        if (typeof str === 'number') return str;
        if (!str) return 0;
        let cleanStr = str.toString().replace(/^"|"$/g, ''); 
        cleanStr = cleanStr.replace(/\./g, ''); 
        cleanStr = cleanStr.replace(',', '.');  
        cleanStr = cleanStr.replace(/[^\d.-]/g, ''); 
        const result = parseFloat(cleanStr);
        return isNaN(result) ? 0 : result;
    };

    const fmtMoney = (n) => new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR' }).format(n);
    const fmtKg = (n) => new Intl.NumberFormat('es-ES', { minimumFractionDigits: 4, maximumFractionDigits: 4 }).format(n);
    const fmtInt = (n) => new Intl.NumberFormat('es-ES', { maximumFractionDigits: 0 }).format(n);
    const fmtPct = (n) => new Intl.NumberFormat('es-ES', { maximumFractionDigits: 0 }).format(n);

    // --- PROCESAR CSV ---
    const processCSV = (text) => {
        const lines = text.split(/\r?\n/).filter(line => line.trim() !== '');
        if (lines.length === 0) return [];

        let delimiter = ',';
        if (lines[0].indexOf(';') > -1) delimiter = ';';

        let departamentosMap = new Map();
        let currentDeptName = "SIN ASIGNAR";

        for (let i = 1; i < lines.length; i++) {
            let rowText = lines[i];
            let cols;
            
            // --- CORRECCI√ìN PARSEO CSV ---
            if (delimiter === ';') {
                cols = rowText.split(';');
            } else {
                cols = rowText.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
            }
            
            cols = cols.map(c => cleanText(c));

            const rawDep = cols[COL_DEPARTAMENTO] || '';
            const rawCentro = cols[COL_CENTRO_GESTION] || '';
            const rawImporte = cols[COL_IMPORTE] || '0';
            const rawTipo = cols[COL_TIPO] || '1';

            if (rawDep !== '') currentDeptName = rawDep.trim();

            if (rawCentro !== '' && !rawCentro.toLowerCase().includes('total')) {
                if (!departamentosMap.has(currentDeptName)) {
                    departamentosMap.set(currentDeptName, {
                        name: currentDeptName,
                        items: [],
                        totalBase: 0
                    });
                }
                const item = {
                    desc: rawCentro,
                    importe: parseNum(rawImporte),
                    tipo: parseInt(rawTipo) || 1
                };
                const deptObj = departamentosMap.get(currentDeptName);
                deptObj.items.push(item);
                deptObj.totalBase += item.importe;
            }
        }
        return Array.from(departamentosMap.values());
    };

    // --- CARGA DE DATOS ---
    async function fetchData() {
        const overlay = document.getElementById('loadingOverlay');
        try {
            overlay.classList.remove('hidden-overlay');
            const [resConfig, resCostes] = await Promise.all([
                fetch(URL_CONFIG),
                fetch(URL_COSTES)
            ]);
            const txtConfig = await resConfig.text();
            const txtCostes = await resCostes.text();

            const linesConfig = txtConfig.split(/\r?\n/);
            linesConfig.forEach(line => {
                if(!line) return;
                const cols = line.split(/[;,]/);
                if(cols.length < 2) return;
                const key = cleanText(cols[0]).toLowerCase();
                const val = parseNum(cleanText(cols[1]));
                if(key.includes('cerdos')) state.cerdosBase = val;
                if(key.includes('peso')) state.pesoBase = val;
            });

            state.departamentos = processCSV(txtCostes);

            // Init Base UI
            const kgBaseTotal = state.cerdosBase * state.pesoBase;
            document.getElementById('baseCerdos').textContent = fmtInt(state.cerdosBase);
            document.getElementById('basePeso').textContent = state.pesoBase.toLocaleString('es-ES');
            document.getElementById('baseTotalKg').textContent = fmtInt(kgBaseTotal);

            // Inicializar render
            render();
            overlay.classList.add('hidden-overlay');

        } catch (e) {
            console.error(e);
            alert("Error cargando datos. Verifica la consola.");
        }
    }

    // --- C√ÅLCULOS Y RENDERIZADO ---
    function render() {
        // 1. Datos Base
        const kgBase = state.cerdosBase * state.pesoBase;

        // 2. Datos Escenario 2
        let kg2 = 0;
        const isManual2 = document.getElementById('checkManual2').checked;
        const inputTotal2 = document.getElementById('totalKg2');
        
        if (isManual2) {
            kg2 = parseNum(inputTotal2.value);
        } else {
            const cerdos2 = parseNum(document.getElementById('cerdos2').value);
            const peso2 = parseFloat(document.getElementById('peso2').value);
            kg2 = cerdos2 * peso2;
            inputTotal2.value = fmtInt(kg2); 
        }
        const factor2 = kgBase > 0 ? kg2 / kgBase : 0;

        // 3. Datos Escenario 3
        let kg3 = 0;
        const isManual3 = document.getElementById('checkManual3').checked;
        const inputTotal3 = document.getElementById('totalKg3');

        if (isManual3) {
            kg3 = parseNum(inputTotal3.value);
        } else {
            const cerdos3 = parseNum(document.getElementById('cerdos3').value);
            const peso3 = parseFloat(document.getElementById('peso3').value);
            kg3 = cerdos3 * peso3;
            inputTotal3.value = fmtInt(kg3);
        }
        const factor3 = kgBase > 0 ? kg3 / kgBase : 0;


        // 4. Construcci√≥n Tabla
        const tbody = document.getElementById('mainTableBody');
        tbody.innerHTML = '';
        let grandTotal = { b: 0, e2: 0, e3: 0 };

        state.departamentos.forEach((dept, index) => {
            let deptTotal = { b: 0, e2: 0, e3: 0 };
            let deptVarPortion = 0; // Para calcular el mix del depto
            let itemsHtml = '';

            dept.items.forEach(item => {
                const c1 = item.importe;
                let c2 = 0, c3 = 0;

                // Fijo / Variable / Semifijo
                if (item.tipo === 1) { // FIJO
                    c2 = c1; c3 = c1;
                    // varPortion suma 0
                } else if (item.tipo === 2) { // VARIABLE
                    c2 = c1 * factor2; c3 = c1 * factor3;
                    deptVarPortion += c1; // 100% variable
                } else if (item.tipo === 3) { // SEMI
                    const f = c1 * 0.81; 
                    const v = c1 * 0.19;
                    c2 = f + (v * factor2); 
                    c3 = f + (v * factor3);
                    deptVarPortion += v; // Solo la parte variable (19%)
                }

                deptTotal.b += c1; deptTotal.e2 += c2; deptTotal.e3 += c3;
                
                const badgeClass = item.tipo === 1 ? 'text-blue-600 bg-blue-50' : 
                                   item.tipo === 3 ? 'text-purple-600 bg-purple-50' : 'text-emerald-600 bg-emerald-50';
                const tipoLabel = item.tipo === 1 ? 'Fijo' : item.tipo === 3 ? 'Semi (19% Var)' : 'Variable';

                itemsHtml += `
                    <tr class="sub-row dept-${index} hidden border-t border-gray-100 transition-colors">
                        <td class="px-4 py-2 pl-12 text-sm text-gray-600 relative">
                            <span class="absolute left-8 top-1/2 -translate-y-1/2 w-2 h-[1px] bg-gray-300"></span>
                            ${item.desc}
                        </td>
                        <td class="px-2 py-2 text-center"><span class="text-[10px] px-1.5 py-0.5 rounded border border-opacity-20 ${badgeClass} whitespace-nowrap">${tipoLabel}</span></td>
                        <td class="px-4 py-2 text-right text-sm text-gray-500 border-l border-slate-100">${fmtMoney(c1)}</td>
                        <td class="px-4 py-2 text-right text-[10px] text-gray-400">${fmtKg(kgBase ? c1/kgBase : 0)}</td>
                        <td class="px-4 py-2 text-right text-sm text-gray-500 bg-sky-50/10 border-l border-sky-50">${fmtMoney(c2)}</td>
                        <td class="px-4 py-2 text-right text-[10px] text-gray-400 bg-sky-50/10">${fmtKg(kg2 ? c2/kg2 : 0)}</td>
                        <td class="px-4 py-2 text-right text-sm text-gray-500 bg-amber-50/10 border-l border-amber-50">${fmtMoney(c3)}</td>
                        <td class="px-4 py-2 text-right text-[10px] text-gray-400 bg-amber-50/10">${fmtKg(kg3 ? c3/kg3 : 0)}</td>
                    </tr>
                `;
            });

            // C√°lculo del Mix del Departamento
            const pctVar = deptTotal.b > 0 ? (deptVarPortion / deptTotal.b) * 100 : 0;
            const pctFix = 100 - pctVar;
            
            // Determinar etiqueta y estilo del departamento
            let deptLabelHtml = '';
            if (Math.round(pctVar) === 0) {
                deptLabelHtml = `<span class="text-[10px] text-blue-600 font-bold bg-blue-50 px-2 py-1 rounded">100% Fijo</span>`;
            } else if (Math.round(pctVar) === 100) {
                deptLabelHtml = `<span class="text-[10px] text-emerald-600 font-bold bg-emerald-50 px-2 py-1 rounded">100% Var</span>`;
            } else {
                deptLabelHtml = `<span class="text-[10px] text-slate-600 font-bold bg-slate-100 px-2 py-1 rounded relative cursor-help" data-title="Fijo: ${fmtPct(pctFix)}% | Var: ${fmtPct(pctVar)}%">Mix Var: ${fmtPct(pctVar)}%</span>`;
            }

            grandTotal.b += deptTotal.b; grandTotal.e2 += deptTotal.e2; grandTotal.e3 += deptTotal.e3;
            const collapseId = `dept-${index}`;
            tbody.insertAdjacentHTML('beforeend', `
                <tbody class="border-b border-gray-200 group">
                    <tr class="dept-row bg-gray-50/80 hover:bg-gray-100 transition-colors select-none" onclick="toggleDept('${collapseId}', this)">
                        <td class="px-4 py-3 font-bold text-gray-700 flex items-center gap-3">
                            <div class="w-5 h-5 flex items-center justify-center rounded bg-gray-200 text-gray-500">
                                <i class="fas fa-chevron-right text-[10px] chevron transition-transform duration-300"></i>
                            </div>
                            <span>${dept.name}</span>
                            <span class="text-[10px] text-gray-400 font-normal ml-auto px-2 py-0.5 bg-white rounded border border-gray-200">${dept.items.length}</span>
                        </td>
                        <td class="px-2 py-3 text-center">${deptLabelHtml}</td>
                        <td class="px-4 py-3 text-right font-bold text-gray-800 border-l border-gray-200 bg-gray-50/50">${fmtMoney(deptTotal.b)}</td>
                        <td class="px-4 py-3 text-right text-xs text-gray-500 bg-gray-50/50 font-mono">${fmtKg(kgBase ? deptTotal.b/kgBase : 0)}</td>
                        <td class="px-4 py-3 text-right font-bold text-sky-700 bg-sky-50/30 border-l border-sky-100">${fmtMoney(deptTotal.e2)}</td>
                        <td class="px-4 py-3 text-right text-xs text-sky-600 bg-sky-50/30 font-mono">${fmtKg(kg2 ? deptTotal.e2/kg2 : 0)}</td>
                        <td class="px-4 py-3 text-right font-bold text-amber-700 bg-amber-50/30 border-l border-amber-100">${fmtMoney(deptTotal.e3)}</td>
                        <td class="px-4 py-3 text-right text-xs text-amber-600 bg-amber-50/30 font-mono">${fmtKg(kg3 ? deptTotal.e3/kg3 : 0)}</td>
                    </tr>
                    ${itemsHtml}
                </tbody>
            `);
        });

        // 5. Total General Footer
        tbody.insertAdjacentHTML('beforeend', `
            <tfoot class="sticky bottom-0 z-40 shadow-[0_-5px_15px_-5px_rgba(0,0,0,0.2)]">
                <tr class="bg-slate-800 text-white font-bold text-sm">
                    <td colspan="2" class="px-4 py-4 text-right uppercase tracking-wider">Total General</td>
                    <td class="px-4 py-4 text-right border-l border-slate-600 text-base">${fmtMoney(grandTotal.b)}</td>
                    <td class="px-4 py-4 text-right text-slate-300 font-mono">${fmtKg(kgBase ? grandTotal.b/kgBase : 0)}</td>
                    <td class="px-4 py-4 text-right bg-slate-700 border-l border-slate-600 text-base">${fmtMoney(grandTotal.e2)}</td>
                    <td class="px-4 py-4 text-right bg-slate-700 text-slate-300 font-mono">${fmtKg(kg2 ? grandTotal.e2/kg2 : 0)}</td>
                    <td class="px-4 py-4 text-right bg-slate-700 border-l border-slate-600 text-base">${fmtMoney(grandTotal.e3)}</td>
                    <td class="px-4 py-4 text-right bg-slate-700 text-slate-300 font-mono">${fmtKg(kg3 ? grandTotal.e3/kg3 : 0)}</td>
                </tr>
            </tfoot>
        `);

        // 6. KPIs Update
        const kpiHTML = (title, kg, cost, color) => `
            <div class="p-4 text-center hover:bg-gray-50 transition-colors">
                <p class="text-[10px] font-bold uppercase text-${color}-500 mb-1 tracking-wider">${title}</p>
                <p class="text-xl font-bold text-slate-800 mb-0.5">${fmtInt(kg)} <span class="text-xs font-normal text-gray-400">kg</span></p>
                <div class="inline-flex items-center gap-1 px-2 py-0.5 bg-${color}-50 rounded-full border border-${color}-100">
                    <i class="fas fa-coins text-${color}-500 text-[10px]"></i>
                    <p class="text-xs font-bold text-${color}-700 font-mono">
                        ${fmtKg(kg ? (title.includes('Base')?grandTotal.b:title.includes('2')?grandTotal.e2:grandTotal.e3)/kg : 0)} ‚Ç¨/kg
                    </p>
                </div>
            </div>
        `;

        document.getElementById('kpiContainer').innerHTML = 
            kpiHTML('Base', kgBase, grandTotal.b, 'slate') +
            kpiHTML('Escenario 2', kg2, grandTotal.e2, 'sky') +
            kpiHTML('Escenario 3', kg3, grandTotal.e3, 'amber');
    }

    // --- FUNCI√ìN TOGGLE ACORDE√ìN ---
    window.toggleDept = function(id, headerEl) {
        const rows = document.getElementsByClassName(id);
        if(rows.length === 0) return;
        
        const isHidden = rows[0].classList.contains('hidden');
        if(isHidden) {
            headerEl.classList.add('expanded');
            headerEl.classList.add('bg-slate-100');
        } else {
            headerEl.classList.remove('expanded');
            headerEl.classList.remove('bg-slate-100');
        }
        for (let row of rows) {
            if (isHidden) row.classList.remove('hidden');
            else row.classList.add('hidden');
        }
    };

    // --- MANEJO DE MODOS MANUALES ---
    function setupModeToggles(idSuffix) {
        const checkbox = document.getElementById('checkManual' + idSuffix);
        const cerdosInput = document.getElementById('cerdos' + idSuffix);
        const pesoInput = document.getElementById('peso' + idSuffix);
        const totalInput = document.getElementById('totalKg' + idSuffix);

        const updateState = () => {
            const isManual = checkbox.checked;
            // Si es Manual: Habilita Total, Deshabilita Cerdos/Peso
            totalInput.disabled = !isManual;
            cerdosInput.disabled = isManual;
            pesoInput.disabled = isManual;
            
            // Recalcular para reflejar cambios visuales (si pasas a manual, mantienes el ultimo valor)
            render();
        };

        checkbox.addEventListener('change', updateState);
        // Tambi√©n actualizar al escribir en Total Kg si estamos en manual
        totalInput.addEventListener('input', (e) => {
             let v = e.target.value.replace(/\D/g, '');
             e.target.value = v ? parseInt(v).toLocaleString('es-ES') : '';
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        fetchData();
        
        // Configurar m√°scaras de miles para inputs Cerdos
        ['cerdos2', 'cerdos3'].forEach(id => {
            const el = document.getElementById(id);
            el.addEventListener('input', (e) => {
                let v = e.target.value.replace(/\D/g, '');
                e.target.value = v ? parseInt(v).toLocaleString('es-ES') : '';
            });
        });

        // Configurar Toggles
        setupModeToggles('2');
        setupModeToggles('3');

        document.getElementById('calcBtn').addEventListener('click', render);
    });
</script>
</body>
</html>